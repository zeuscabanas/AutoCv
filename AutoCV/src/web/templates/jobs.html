{% extends "base.html" %}

{% block title %}Ofertas{% endblock %}

{% block content %}
<div x-data="jobsPage()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Ofertas de Trabajo</h1>
            <p class="text-gray-500 mt-1">Gestiona las ofertas encontradas</p>
        </div>
        <div class="flex gap-3">
            <a href="/search" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Nueva Búsqueda
            </a>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1">
                <input type="text" x-model="searchFilter" placeholder="Buscar ofertas..."
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
            </div>
            <select x-model="companyFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">Todas las empresas</option>
                <template x-for="company in companies" :key="company">
                    <option :value="company" x-text="company"></option>
                </template>
            </select>
            <span class="text-sm text-gray-500" x-text="filteredJobs.length + ' ofertas'"></span>
        </div>
    </div>
    
    <!-- Jobs Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <template x-for="job in filteredJobs" :key="job.id">
            <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition-all">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800" x-text="job.title"></h3>
                        <p class="text-primary-600 font-medium" x-text="job.company"></p>
                    </div>
                    <div class="flex gap-2">
                        <button @click="viewJob(job)" 
                                class="p-2 text-gray-400 hover:text-primary-500 hover:bg-primary-50 rounded-lg transition-colors"
                                title="Ver detalles">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                        <button @click="deleteJob(job.id)"
                                class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                title="Eliminar">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 text-sm text-gray-500 mb-4">
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span x-text="job.location"></span>
                    </span>
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span x-text="formatDate(job.scraped_at)"></span>
                    </span>
                </div>
                
                <p class="text-sm text-gray-600 mb-4 line-clamp-3" x-text="job.description?.substring(0, 200) + '...' || 'Sin descripción'"></p>
                
                <div class="flex items-center justify-between pt-4 border-t">
                    <a :href="job.url" target="_blank" class="text-sm text-primary-500 hover:underline flex items-center gap-1">
                        Ver en LinkedIn
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                    <button @click="generateCV(job)" :disabled="generating"
                            class="px-4 py-2 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 flex items-center gap-2">
                        <svg x-show="generating" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <svg x-show="!generating" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span x-text="generating ? 'Generando...' : 'Generar CV'"></span>
                    </button>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Empty State -->
    <div x-show="jobs.length === 0" class="text-center py-16">
        <div class="w-24 h-24 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-6">
            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        </div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">No hay ofertas guardadas</h3>
        <p class="text-gray-500 mb-6">Realiza una búsqueda para encontrar ofertas de trabajo</p>
        <a href="/search" class="px-6 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity inline-flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            Buscar Ofertas
        </a>
    </div>
    
    <!-- Job Detail Modal -->
    <div x-show="selectedJob" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         @click.self="selectedJob = null">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex items-start justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800" x-text="selectedJob?.title"></h2>
                        <p class="text-primary-600 font-medium" x-text="selectedJob?.company"></p>
                    </div>
                    <button @click="selectedJob = null" class="p-2 hover:bg-gray-100 rounded-lg">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto max-h-[50vh]">
                <div class="flex items-center gap-4 text-sm text-gray-500 mb-4">
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        </svg>
                        <span x-text="selectedJob?.location"></span>
                    </span>
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span x-text="formatDate(selectedJob?.scraped_at)"></span>
                    </span>
                </div>
                
                <h3 class="font-semibold text-gray-800 mb-2">Descripción</h3>
                <div class="text-sm text-gray-600 whitespace-pre-wrap" x-text="selectedJob?.description || 'Sin descripción disponible'"></div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex items-center justify-between">
                <a :href="selectedJob?.url" target="_blank" class="text-primary-500 hover:underline flex items-center gap-1">
                    Ver en LinkedIn
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                </a>
                <button @click="generateCV(selectedJob); selectedJob = null" :disabled="generating"
                        class="px-6 py-2 gradient-bg text-white rounded-lg hover:opacity-90 disabled:opacity-50">
                    Generar CV para esta oferta
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function jobsPage() {
        return {
            jobs: [],
            selectedJob: null,
            searchFilter: '',
            companyFilter: '',
            generating: false,
            
            get companies() {
                return [...new Set(this.jobs.map(j => j.company))].sort();
            },
            
            get filteredJobs() {
                return this.jobs.filter(job => {
                    const matchesSearch = !this.searchFilter || 
                        job.title.toLowerCase().includes(this.searchFilter.toLowerCase()) ||
                        job.company.toLowerCase().includes(this.searchFilter.toLowerCase()) ||
                        job.description?.toLowerCase().includes(this.searchFilter.toLowerCase());
                    
                    const matchesCompany = !this.companyFilter || job.company === this.companyFilter;
                    
                    return matchesSearch && matchesCompany;
                });
            },
            
            async init() {
                await this.loadJobs();
            },
            
            async loadJobs() {
                try {
                    const response = await fetch('/api/jobs');
                    const data = await response.json();
                    this.jobs = data.jobs || [];
                } catch (e) {
                    console.error('Error cargando ofertas:', e);
                    alert('Error cargando ofertas');
                }
            },
            
            viewJob(job) {
                this.selectedJob = job;
            },
            
            async deleteJob(jobId) {
                if (!confirm('¿Estás seguro de eliminar esta oferta?')) return;
                
                try {
                    const response = await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
                    if (response.ok) {
                        alert('Oferta eliminada');
                        await this.loadJobs();
                    } else {
                        throw new Error('Error eliminando');
                    }
                } catch (e) {
                    console.error('Error:', e);
                    alert('Error eliminando oferta');
                }
            },
            
            async generateCV(job) {
                if (this.generating) return;
                
                this.generating = true;
                console.log('Generando CV para:', job.id, job.title);
                
                try {
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            job_id: job.id,
                            include_cover_letter: true
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.detail || 'Error al generar CV');
                    }
                    
                    alert('¡Generación de CV iniciada! Ve a "CVs Generados" para ver el resultado.');
                    console.log('Generación iniciada:', data);
                } catch (e) {
                    console.error('Error generando CV:', e);
                    alert('Error: ' + e.message);
                } finally {
                    this.generating = false;
                }
            },
            
            formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
            }
        }
    }
</script>
{% endblock %}
